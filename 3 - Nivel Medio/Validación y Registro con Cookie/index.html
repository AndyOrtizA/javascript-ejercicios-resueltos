<!DOCTYPE html>
<!--
 @author Raúl Caro Pastorino
 @copyright Copyright © 2017 Raúl Caro Pastorino
 @license https://wwww.gnu.org/licenses/gpl.txt
-->

<!--
↓ INSTRUCCIONES DEL EJERCICIO ↓

-->
<html lang="es">
    <head>
        <meta charset="utf-8" />
        <title>EJ 1</title>
        <style type="text/css">
          .error{color:red;}
        </style>

        <script src="limpiar_codigo.js"></script>
        <script src="cookies.js"></script>

        <script>
            if (getCookie('misesion') == true) {
                alert('Existe sesión → Dibujar datos');
            }

            var inputs = document.getElementsByTagName('input');
            var labels = document.getElementsByTagName('label');

            // Recibe el número de input

            /**
             * Muestra error de entrada vacía en el campo input pasado
             * @param  {Integer}  entrada  Recibe el número de input
             */
            function entradaVacia(entrada) {
                var nodoError = document.createElement('p');
                var nodoTexto = document.createTextNode('No puede ser vacío');
                nodoError.appendChild(nodoTexto);

                if (labels[entrada].children.length > 1) {
                    labels[entrada].replaceChild(nodoError);
                } else {
                    labels[entrada].appendChild(nodoError);
                }
            }

            /**
             * Muestra errores al ser inválido un formato.
             * @param  {Integer}  entrada  Recibe el número de input
             */
            function formatoInvalido(entrada) {
                var nodoError = document.createElement('p');
                var nodoTexto = document.createTextNode('No coincide el formato');
                nodoError.appendChild(nodoTexto);

                alert(labels[entrada].children.length);

                if (labels[entrada].children.length > 1) {
                    labels[entrada].replaceChild(nodoError);
                } else {
                    labels[entrada].appendChild(nodoError);
                }
            }

            /**
             * Limpia errores si es válido el formato en un input
             */
            function formatoValido() {
                // Limpiar todos los inputs
                for (x of inputs) {
                    // si el padre tiene más de un hijo borra todos menos primero
                }
            }

            function comprobarUsuario() {
                var entrada = inputs[0].value;

                patron = new RegExp("[a-z]+[A-Z]+[0-9]+");

                if (entrada === '') {
                    entradaVacia(0);
                    return false;
                } else if (patron.test(inputs[0].value) === false) {
                    formatoInvalido(0);
                    return false;
                }
                return true;
            }

            function comprobarTelefono() {
                var entrada = inputs[1].value;

                //TOFIX → patrón, no funciona con espacio
                patron = new RegExp("\([0-9]{3}\)+[0-9]{2}\-[0-9]{2}\-[0-9]{2}");

                if (entrada === '') {
                    entradaVacia(1);
                }
                else if (patron.test(entrada) === false) {
                    formatoInvalido(1);
                }

                return patron.test(entrada);
            }

            function comprobarMeses() {
                var entrada = inputs[2].value;
                if (entrada === '') {
                    entradaVacia(2);
                    return false;

                // TOFIX → Comprobar si es una cadena:
                } else if (isNaN(Number(entrada)) === NaN) {
                    formatoInvalido(2);
                    return false;
                } else if (! (entrada >= 1 && entrada <= 24)) {
                    formatoInvalido(2);
                    return false;
                }
                return true;
            }

            function generarSesion() {
                if (comprobarUsuario() && comprobarTelefono() &&comprobarMeses()) {
                    var ventana = window.open('EJ1_Ventana.html', 'nueva_ventana', "width=300px, height=200px");
                    setInterval(function(){ventana.close}, 3000);

                    // No funciona recarga de la página
                    //reload();
                    //
                    // Poner meses...
                    setCookie('misesion', 'true');
                }
            }

            window.onload = function() {
                buscar();
                inputs[0].addEventListener('blur', comprobarUsuario);
                inputs[1].addEventListener('blur', comprobarTelefono);
                inputs[2].addEventListener('blur', comprobarMeses);
                inputs[3].addEventListener('blur', generarSesion);
            }
        </script>
    </head>
        <body>
              <h1>Formulario de registo Formación Doñana</h1>
              <form>

                  <label>Nombre:
                        <input type="text" title='Debe contener al menos una minúscula, mayúscula,número y alguno de estos signos (. - _)' />
                  </label>
                  <br>
                  <label>Teléfono:
                        <input name="telefono" type="text"  placeholder='(XXX) XX-XX-XX' />
                  </label>
                  <br>
                  <label>Nº meses:
                        <input type="number"  min='1' max='24' title='Debe introducir una cantidad entre 1 y 24'/>
                  </label>
                  <br><br>

                  <input type="submit" value="Registrar" />

              </form>

        </body>
</html>
